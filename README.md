# iOS App Employing Firebase Authentication with Keyri Passwordless Auth + QR Login

This is a companion mobile app for the Keyri example passwordless authentication server and web application for Firebase: https://github.com/Keyri-Co/keyri-firebase-serverside-authentication

This app allows users to authenticate through Firebase Authentication using Firebase's built-in email/password auth provider as well as [Keyri's](https://keyri.com) full passwordless and QR login capabilities, which is the focus of this application.

With the Keyri full passwordless option, users can simply register and log in by submitting their email address. That serves as their user profile identifier, while a private key in their phone's secure enclave serves as the primary credential. Upon passwordless registration, a key pair is generated by the Keyri iOS SDK, and the public key is sent to the server linked to above, which in turn saves it to the user's profile.

Passwordless login within the app involves sending a signed authentication request to a different endpoint on the same server. In both cases, a Firebase custom token is returned, which is used by the Firebase client SDK also installed in this app to fully log the user in.

Passwordless authentication in the app can also be extended to this application's associated web application (https://keyri-firebase-serverside-authentication.vercel.app/) by scanning the QR code with a scanner built into this app, provided by the Keyri SDK.

# Keyri + Firebase iOS App Summary Documentation

## Install Keyri and Firebase SDKs

```none
  # Pods for KeyriFirebase
  pod 'keyri-pod'
  pod 'FirebaseAuth'
```

Import the following Cocoapods (also available via SPM)

To set up Firebase, follow their setup guide on their developer portal, then download the generated GoogleService-Info.plist file and place it at the root of your project (details on how to get this in the "Get Firebase Client Credentials" section above.

Then, simply import Keyri and Firebase in the files you intend to use them

## Register a Passwordless User

To register a user, one first must set up a keypair with the Keyri SDK and send it to their custom server (details on how to implement that portion in the Server section above). The web server responds with a custom token, which the mobile app uses to get a user from the Firebase SDK using the custom auth method. The code snippet below shows how one can accomplish this easily:&#x20;

Note: We force unwrap in several places for brevity, please be careful with that in production code

```swift
    static func register(username: String) {
        let key = try! Keyri().generateAssociationKey(username: username).derRepresentation.base64EncodedString
        
        let body = "{\"email\": \"\(username)\",\"publicKey\": \"\(String(describing: key))\"}"
        
        var httpReq = URLRequest(url: URL(string: "url.tld/keyriregister")!)
        httpReq.httpBody = body.data(using: .utf8)!
        
        URLSession.shared.dataTask(with: httpReq) { data, _, _ in
            if let data = data {
                let token = String(data: data, encoding: .utf8)!
                Auth.auth().signIn(withCustomToken: token) { user, error in
                    if let user = user {
                        // Log in the user
                    }
                    
                }
            }
            
        }.resume()
```

## Sign in an Existing User In-App

To sign in an existing user, the flow is actually very similar to the registration piece, just with one alteration: the body sent to the custom API (and the endpoint of course). After that, one takes the response from the API (a custom token) and authenticates the same as above. The format of the custom token is&#x20;

```json
{
  "email": "abc@xyz.tld",
  "data": "[utf-8 encoded ${timestamp_nonce} string]",
  "signature": "[base64-encoded ECDH signature]"
}
```

One can use the Keyri SDK to generate this payload, first by looking up the user in Keyri's sdk, and using the key to sign the data (there is a function built into Keyri that does this for you). We display this below

```swift
    static func signIn(username: String) {
        let keyri = Keyri()
        
        if let key = try! keyri.getAssociationKey(username: username) {
            let data =  String(Date.now()) + "_" + String(RandomNumberGenerator().random(100000))
            let signature = try! keyri.generateUserSignature(data: data)
            let payload = "{\"username\": \(username),\"data\": \(data),\"signature\": \"\(signature)\"}"
        }
    }
```

This payload can then be sent to the custom API, which will respond with a Custom Token, which can be used to authenticate the user as shown above.&#x20;

## Sign in an Existing User on Web App via QR Login

Alternatively, one can send the same payload to a browser session via Keyri's QR Auth functionality, using the easyKeyriAuth function:

```swift
Keyri().easyKeyriAuth(username: username, appKey: appKey, payload: payload)
```
